{"EDITOR_STATE":{"allProjectFiles":{"5e54d49e-8477-4f74-b2fb-883f1c69b7b8":{"id":"5e54d49e-8477-4f74-b2fb-883f1c69b7b8","parent":null,"name":"EZ","type":"DIRECTORY","isDirectory":true,"children":["702971c8-fa81-4c9f-9935-f46156b62d1d"],"isRemovable":false,"filePath":"EZ"},"702971c8-fa81-4c9f-9935-f46156b62d1d":{"id":"702971c8-fa81-4c9f-9935-f46156b62d1d","parent":"5e54d49e-8477-4f74-b2fb-883f1c69b7b8","name":"handler.js","type":"LAMBDA_FILE","isDirectory":false,"children":[],"isRemovable":true,"filePath":"EZ/handler.js","code":"// adapted from https://docs.aws.amazon.com/lambda/latest/dg/with-s3-example-deployment-pkg.html\n\n// dependencies\nlet AWS = require('aws-sdk');\nlet async = require('async');\nlet gm = require('gm')\n    .subClass({ imageMagick: true }); // Enable ImageMagick integration.\nlet util = require('util');\n\n// get reference to S3 client \nconst s3 = new AWS.S3();\n\n// constants\nconst MAX_WIDTH = 100;\nconst MAX_HEIGHT = 100;\n\nexports.handler = function (event, context, callback) {\n\n    // Read options from the event.\n    console.log(\"Reading options from event:\\n\", util.inspect(event, { depth: 5 }));\n    // Object key may have spaces or unicode non-ASCII characters.\n    let srcBucket = event.Records[0].s3.bucket.name;\n    let srcKey = decodeURIComponent(event.Records[0].s3.object.key.replace(/\\+/g, \" \"));\n    let dstBucket = srcBucket;\n    let dstKey = \"thumb-\" + srcKey;\n\n    // Infer the image type.\n    let typeMatch = srcKey.match(/\\.([^.]*)$/);\n    if (!typeMatch) {\n        callback(\"Could not determine the image type.\");\n        return;\n    }\n    let imageType = typeMatch[1];\n    if (imageType != \"jpg\" && imageType != \"png\") {\n        callback(`Unsupported image type: ${imageType}`);\n        return;\n    }\n\n    // Download the image from S3, transform, and upload under new key.\n    async.waterfall([\n        function download(next) {\n            // Download the image from S3 into a buffer.\n            s3.getObject({\n                'Bucket': srcBucket,\n                'Key': srcKey\n            }, next);\n        },\n        function transform(response, next) {\n            gm(response.Body).size(function (err, size) {\n                // Infer the scaling factor to avoid stretching the image unnaturally.\n                let scalingFactor = Math.min(\n                    MAX_WIDTH / size.width,\n                    MAX_HEIGHT / size.height\n                );\n                let width = scalingFactor * size.width;\n                let height = scalingFactor * size.height;\n\n                // Transform the image buffer in memory.\n                this.resize(width, height)\n                    .toBuffer(imageType, function (err, buffer) {\n                        if (err) {\n                            next(err);\n                        } else {\n                            next(null, response.ContentType, buffer);\n                        }\n                    });\n            });\n        },\n        function upload(contentType, data, next) {\n            // Stream the transformed image to a different S3 bucket.\n            s3.putObject({\n                \"Body\": data,\n                \"Bucket\": dstBucket,\n                \"Key\": dstKey,\n                \"ContentType\": contentType\n            }, next);\n        }\n    ], function (err) {\n        let msg;\n        if (err) {\n            msg = `Unable to resize ${srcBucket}/${srcKey} and upload to ${dstBucket}/${dstKey} due to an error: ${err}`;\n            console.error(msg);\n        } else {\n            msg = `Successfully resized ${srcBucket}/${srcKey} and uploaded to ${dstBucket}/${dstKey}`;\n            console.log(msg);\n        }\n        callback(err, msg);\n    }\n    );\n};\n","ast":{"type":"File","start":0,"end":3148,"loc":{"start":{"line":1,"column":0},"end":{"line":91,"column":0}},"program":{"type":"Program","start":0,"end":3148,"loc":{"start":{"line":1,"column":0},"end":{"line":91,"column":0}},"sourceType":"module","body":[{"type":"VariableDeclaration","start":114,"end":143,"loc":{"start":{"line":4,"column":0},"end":{"line":4,"column":29}},"declarations":[{"type":"VariableDeclarator","start":118,"end":142,"loc":{"start":{"line":4,"column":4},"end":{"line":4,"column":28}},"id":{"type":"Identifier","start":118,"end":121,"loc":{"start":{"line":4,"column":4},"end":{"line":4,"column":7},"identifierName":"AWS"},"name":"AWS","leadingComments":null},"init":{"type":"CallExpression","start":124,"end":142,"loc":{"start":{"line":4,"column":10},"end":{"line":4,"column":28}},"callee":{"type":"Identifier","start":124,"end":131,"loc":{"start":{"line":4,"column":10},"end":{"line":4,"column":17},"identifierName":"require"},"name":"require"},"arguments":[{"type":"StringLiteral","start":132,"end":141,"loc":{"start":{"line":4,"column":18},"end":{"line":4,"column":27}},"extra":{"rawValue":"aws-sdk","raw":"'aws-sdk'"},"value":"aws-sdk"}]},"leadingComments":null}],"kind":"let","leadingComments":[{"type":"CommentLine","value":" adapted from https://docs.aws.amazon.com/lambda/latest/dg/with-s3-example-deployment-pkg.html","start":0,"end":96,"loc":{"start":{"line":1,"column":0},"end":{"line":1,"column":96}}},{"type":"CommentLine","value":" dependencies","start":98,"end":113,"loc":{"start":{"line":3,"column":0},"end":{"line":3,"column":15}}}]},{"type":"VariableDeclaration","start":144,"end":173,"loc":{"start":{"line":5,"column":0},"end":{"line":5,"column":29}},"declarations":[{"type":"VariableDeclarator","start":148,"end":172,"loc":{"start":{"line":5,"column":4},"end":{"line":5,"column":28}},"id":{"type":"Identifier","start":148,"end":153,"loc":{"start":{"line":5,"column":4},"end":{"line":5,"column":9},"identifierName":"async"},"name":"async"},"init":{"type":"CallExpression","start":156,"end":172,"loc":{"start":{"line":5,"column":12},"end":{"line":5,"column":28}},"callee":{"type":"Identifier","start":156,"end":163,"loc":{"start":{"line":5,"column":12},"end":{"line":5,"column":19},"identifierName":"require"},"name":"require"},"arguments":[{"type":"StringLiteral","start":164,"end":171,"loc":{"start":{"line":5,"column":20},"end":{"line":5,"column":27}},"extra":{"rawValue":"async","raw":"'async'"},"value":"async"}]}}],"kind":"let"},{"type":"VariableDeclaration","start":174,"end":234,"loc":{"start":{"line":6,"column":0},"end":{"line":7,"column":37}},"declarations":[{"type":"VariableDeclarator","start":178,"end":233,"loc":{"start":{"line":6,"column":4},"end":{"line":7,"column":36}},"id":{"type":"Identifier","start":178,"end":180,"loc":{"start":{"line":6,"column":4},"end":{"line":6,"column":6},"identifierName":"gm"},"name":"gm"},"init":{"type":"CallExpression","start":183,"end":233,"loc":{"start":{"line":6,"column":9},"end":{"line":7,"column":36}},"callee":{"type":"MemberExpression","start":183,"end":210,"loc":{"start":{"line":6,"column":9},"end":{"line":7,"column":13}},"object":{"type":"CallExpression","start":183,"end":196,"loc":{"start":{"line":6,"column":9},"end":{"line":6,"column":22}},"callee":{"type":"Identifier","start":183,"end":190,"loc":{"start":{"line":6,"column":9},"end":{"line":6,"column":16},"identifierName":"require"},"name":"require"},"arguments":[{"type":"StringLiteral","start":191,"end":195,"loc":{"start":{"line":6,"column":17},"end":{"line":6,"column":21}},"extra":{"rawValue":"gm","raw":"'gm'"},"value":"gm"}]},"property":{"type":"Identifier","start":202,"end":210,"loc":{"start":{"line":7,"column":5},"end":{"line":7,"column":13},"identifierName":"subClass"},"name":"subClass"},"computed":false},"arguments":[{"type":"ObjectExpression","start":211,"end":232,"loc":{"start":{"line":7,"column":14},"end":{"line":7,"column":35}},"properties":[{"type":"ObjectProperty","start":213,"end":230,"loc":{"start":{"line":7,"column":16},"end":{"line":7,"column":33}},"method":false,"key":{"type":"Identifier","start":213,"end":224,"loc":{"start":{"line":7,"column":16},"end":{"line":7,"column":27},"identifierName":"imageMagick"},"name":"imageMagick"},"computed":false,"shorthand":false,"value":{"type":"BooleanLiteral","start":226,"end":230,"loc":{"start":{"line":7,"column":29},"end":{"line":7,"column":33}},"value":true}}]}]}}],"kind":"let","trailingComments":[{"type":"CommentLine","value":" Enable ImageMagick integration.","start":235,"end":269,"loc":{"start":{"line":7,"column":38},"end":{"line":7,"column":72}}}]},{"type":"VariableDeclaration","start":270,"end":297,"loc":{"start":{"line":8,"column":0},"end":{"line":8,"column":27}},"declarations":[{"type":"VariableDeclarator","start":274,"end":296,"loc":{"start":{"line":8,"column":4},"end":{"line":8,"column":26}},"id":{"type":"Identifier","start":274,"end":278,"loc":{"start":{"line":8,"column":4},"end":{"line":8,"column":8},"identifierName":"util"},"name":"util","leadingComments":null},"init":{"type":"CallExpression","start":281,"end":296,"loc":{"start":{"line":8,"column":11},"end":{"line":8,"column":26}},"callee":{"type":"Identifier","start":281,"end":288,"loc":{"start":{"line":8,"column":11},"end":{"line":8,"column":18},"identifierName":"require"},"name":"require"},"arguments":[{"type":"StringLiteral","start":289,"end":295,"loc":{"start":{"line":8,"column":19},"end":{"line":8,"column":25}},"extra":{"rawValue":"util","raw":"'util'"},"value":"util"}]},"leadingComments":null}],"kind":"let","leadingComments":[{"type":"CommentLine","value":" Enable ImageMagick integration.","start":235,"end":269,"loc":{"start":{"line":7,"column":38},"end":{"line":7,"column":72}}}],"trailingComments":[{"type":"CommentLine","value":" get reference to S3 client ","start":299,"end":329,"loc":{"start":{"line":10,"column":0},"end":{"line":10,"column":30}}}]},{"type":"VariableDeclaration","start":330,"end":354,"loc":{"start":{"line":11,"column":0},"end":{"line":11,"column":24}},"declarations":[{"type":"VariableDeclarator","start":336,"end":353,"loc":{"start":{"line":11,"column":6},"end":{"line":11,"column":23}},"id":{"type":"Identifier","start":336,"end":338,"loc":{"start":{"line":11,"column":6},"end":{"line":11,"column":8},"identifierName":"s3"},"name":"s3","leadingComments":null},"init":{"type":"NewExpression","start":341,"end":353,"loc":{"start":{"line":11,"column":11},"end":{"line":11,"column":23}},"callee":{"type":"MemberExpression","start":345,"end":351,"loc":{"start":{"line":11,"column":15},"end":{"line":11,"column":21}},"object":{"type":"Identifier","start":345,"end":348,"loc":{"start":{"line":11,"column":15},"end":{"line":11,"column":18},"identifierName":"AWS"},"name":"AWS"},"property":{"type":"Identifier","start":349,"end":351,"loc":{"start":{"line":11,"column":19},"end":{"line":11,"column":21},"identifierName":"S3"},"name":"S3"},"computed":false},"arguments":[]},"leadingComments":null}],"kind":"const","leadingComments":[{"type":"CommentLine","value":" get reference to S3 client ","start":299,"end":329,"loc":{"start":{"line":10,"column":0},"end":{"line":10,"column":30}}}],"trailingComments":[{"type":"CommentLine","value":" constants","start":356,"end":368,"loc":{"start":{"line":13,"column":0},"end":{"line":13,"column":12}}}]},{"type":"VariableDeclaration","start":369,"end":391,"loc":{"start":{"line":14,"column":0},"end":{"line":14,"column":22}},"declarations":[{"type":"VariableDeclarator","start":375,"end":390,"loc":{"start":{"line":14,"column":6},"end":{"line":14,"column":21}},"id":{"type":"Identifier","start":375,"end":384,"loc":{"start":{"line":14,"column":6},"end":{"line":14,"column":15},"identifierName":"MAX_WIDTH"},"name":"MAX_WIDTH","leadingComments":null},"init":{"type":"NumericLiteral","start":387,"end":390,"loc":{"start":{"line":14,"column":18},"end":{"line":14,"column":21}},"extra":{"rawValue":100,"raw":"100"},"value":100},"leadingComments":null}],"kind":"const","leadingComments":[{"type":"CommentLine","value":" constants","start":356,"end":368,"loc":{"start":{"line":13,"column":0},"end":{"line":13,"column":12}}}]},{"type":"VariableDeclaration","start":392,"end":415,"loc":{"start":{"line":15,"column":0},"end":{"line":15,"column":23}},"declarations":[{"type":"VariableDeclarator","start":398,"end":414,"loc":{"start":{"line":15,"column":6},"end":{"line":15,"column":22}},"id":{"type":"Identifier","start":398,"end":408,"loc":{"start":{"line":15,"column":6},"end":{"line":15,"column":16},"identifierName":"MAX_HEIGHT"},"name":"MAX_HEIGHT"},"init":{"type":"NumericLiteral","start":411,"end":414,"loc":{"start":{"line":15,"column":19},"end":{"line":15,"column":22}},"extra":{"rawValue":100,"raw":"100"},"value":100}}],"kind":"const"},{"type":"ExpressionStatement","start":417,"end":3147,"loc":{"start":{"line":17,"column":0},"end":{"line":90,"column":2}},"expression":{"type":"AssignmentExpression","start":417,"end":3146,"loc":{"start":{"line":17,"column":0},"end":{"line":90,"column":1}},"operator":"=","left":{"type":"MemberExpression","start":417,"end":432,"loc":{"start":{"line":17,"column":0},"end":{"line":17,"column":15}},"object":{"type":"Identifier","start":417,"end":424,"loc":{"start":{"line":17,"column":0},"end":{"line":17,"column":7},"identifierName":"exports"},"name":"exports"},"property":{"type":"Identifier","start":425,"end":432,"loc":{"start":{"line":17,"column":8},"end":{"line":17,"column":15},"identifierName":"handler"},"name":"handler"},"computed":false},"right":{"type":"FunctionExpression","start":435,"end":3146,"loc":{"start":{"line":17,"column":18},"end":{"line":90,"column":1}},"id":null,"generator":false,"async":false,"params":[{"type":"Identifier","start":445,"end":450,"loc":{"start":{"line":17,"column":28},"end":{"line":17,"column":33},"identifierName":"event"},"name":"event"},{"type":"Identifier","start":452,"end":459,"loc":{"start":{"line":17,"column":35},"end":{"line":17,"column":42},"identifierName":"context"},"name":"context"},{"type":"Identifier","start":461,"end":469,"loc":{"start":{"line":17,"column":44},"end":{"line":17,"column":52},"identifierName":"callback"},"name":"callback"}],"body":{"type":"BlockStatement","start":471,"end":3146,"loc":{"start":{"line":17,"column":54},"end":{"line":90,"column":1}},"body":[{"type":"ExpressionStatement","start":514,"end":594,"loc":{"start":{"line":20,"column":4},"end":{"line":20,"column":84}},"expression":{"type":"CallExpression","start":514,"end":593,"loc":{"start":{"line":20,"column":4},"end":{"line":20,"column":83}},"callee":{"type":"MemberExpression","start":514,"end":525,"loc":{"start":{"line":20,"column":4},"end":{"line":20,"column":15}},"object":{"type":"Identifier","start":514,"end":521,"loc":{"start":{"line":20,"column":4},"end":{"line":20,"column":11},"identifierName":"console"},"name":"console","leadingComments":null},"property":{"type":"Identifier","start":522,"end":525,"loc":{"start":{"line":20,"column":12},"end":{"line":20,"column":15},"identifierName":"log"},"name":"log"},"computed":false,"leadingComments":null},"arguments":[{"type":"StringLiteral","start":526,"end":557,"loc":{"start":{"line":20,"column":16},"end":{"line":20,"column":47}},"extra":{"rawValue":"Reading options from event:\n","raw":"\"Reading options from event:\\n\""},"value":"Reading options from event:\n"},{"type":"CallExpression","start":559,"end":592,"loc":{"start":{"line":20,"column":49},"end":{"line":20,"column":82}},"callee":{"type":"MemberExpression","start":559,"end":571,"loc":{"start":{"line":20,"column":49},"end":{"line":20,"column":61}},"object":{"type":"Identifier","start":559,"end":563,"loc":{"start":{"line":20,"column":49},"end":{"line":20,"column":53},"identifierName":"util"},"name":"util"},"property":{"type":"Identifier","start":564,"end":571,"loc":{"start":{"line":20,"column":54},"end":{"line":20,"column":61},"identifierName":"inspect"},"name":"inspect"},"computed":false},"arguments":[{"type":"Identifier","start":572,"end":577,"loc":{"start":{"line":20,"column":62},"end":{"line":20,"column":67},"identifierName":"event"},"name":"event"},{"type":"ObjectExpression","start":579,"end":591,"loc":{"start":{"line":20,"column":69},"end":{"line":20,"column":81}},"properties":[{"type":"ObjectProperty","start":581,"end":589,"loc":{"start":{"line":20,"column":71},"end":{"line":20,"column":79}},"method":false,"key":{"type":"Identifier","start":581,"end":586,"loc":{"start":{"line":20,"column":71},"end":{"line":20,"column":76},"identifierName":"depth"},"name":"depth"},"computed":false,"shorthand":false,"value":{"type":"NumericLiteral","start":588,"end":589,"loc":{"start":{"line":20,"column":78},"end":{"line":20,"column":79}},"extra":{"rawValue":5,"raw":"5"},"value":5}}]}]}],"leadingComments":null},"leadingComments":[{"type":"CommentLine","value":" Read options from the event.","start":478,"end":509,"loc":{"start":{"line":19,"column":4},"end":{"line":19,"column":35}}}],"trailingComments":[{"type":"CommentLine","value":" Object key may have spaces or unicode non-ASCII characters.","start":599,"end":661,"loc":{"start":{"line":21,"column":4},"end":{"line":21,"column":66}}}]},{"type":"VariableDeclaration","start":666,"end":714,"loc":{"start":{"line":22,"column":4},"end":{"line":22,"column":52}},"declarations":[{"type":"VariableDeclarator","start":670,"end":713,"loc":{"start":{"line":22,"column":8},"end":{"line":22,"column":51}},"id":{"type":"Identifier","start":670,"end":679,"loc":{"start":{"line":22,"column":8},"end":{"line":22,"column":17},"identifierName":"srcBucket"},"name":"srcBucket","leadingComments":null},"init":{"type":"MemberExpression","start":682,"end":713,"loc":{"start":{"line":22,"column":20},"end":{"line":22,"column":51}},"object":{"type":"MemberExpression","start":682,"end":708,"loc":{"start":{"line":22,"column":20},"end":{"line":22,"column":46}},"object":{"type":"MemberExpression","start":682,"end":701,"loc":{"start":{"line":22,"column":20},"end":{"line":22,"column":39}},"object":{"type":"MemberExpression","start":682,"end":698,"loc":{"start":{"line":22,"column":20},"end":{"line":22,"column":36}},"object":{"type":"MemberExpression","start":682,"end":695,"loc":{"start":{"line":22,"column":20},"end":{"line":22,"column":33}},"object":{"type":"Identifier","start":682,"end":687,"loc":{"start":{"line":22,"column":20},"end":{"line":22,"column":25},"identifierName":"event"},"name":"event"},"property":{"type":"Identifier","start":688,"end":695,"loc":{"start":{"line":22,"column":26},"end":{"line":22,"column":33},"identifierName":"Records"},"name":"Records"},"computed":false},"property":{"type":"NumericLiteral","start":696,"end":697,"loc":{"start":{"line":22,"column":34},"end":{"line":22,"column":35}},"extra":{"rawValue":0,"raw":"0"},"value":0},"computed":true},"property":{"type":"Identifier","start":699,"end":701,"loc":{"start":{"line":22,"column":37},"end":{"line":22,"column":39},"identifierName":"s3"},"name":"s3"},"computed":false},"property":{"type":"Identifier","start":702,"end":708,"loc":{"start":{"line":22,"column":40},"end":{"line":22,"column":46},"identifierName":"bucket"},"name":"bucket"},"computed":false},"property":{"type":"Identifier","start":709,"end":713,"loc":{"start":{"line":22,"column":47},"end":{"line":22,"column":51},"identifierName":"name"},"name":"name"},"computed":false},"leadingComments":null}],"kind":"let","leadingComments":[{"type":"CommentLine","value":" Object key may have spaces or unicode non-ASCII characters.","start":599,"end":661,"loc":{"start":{"line":21,"column":4},"end":{"line":21,"column":66}}}]},{"type":"VariableDeclaration","start":719,"end":803,"loc":{"start":{"line":23,"column":4},"end":{"line":23,"column":88}},"declarations":[{"type":"VariableDeclarator","start":723,"end":802,"loc":{"start":{"line":23,"column":8},"end":{"line":23,"column":87}},"id":{"type":"Identifier","start":723,"end":729,"loc":{"start":{"line":23,"column":8},"end":{"line":23,"column":14},"identifierName":"srcKey"},"name":"srcKey"},"init":{"type":"CallExpression","start":732,"end":802,"loc":{"start":{"line":23,"column":17},"end":{"line":23,"column":87}},"callee":{"type":"Identifier","start":732,"end":750,"loc":{"start":{"line":23,"column":17},"end":{"line":23,"column":35},"identifierName":"decodeURIComponent"},"name":"decodeURIComponent"},"arguments":[{"type":"CallExpression","start":751,"end":801,"loc":{"start":{"line":23,"column":36},"end":{"line":23,"column":86}},"callee":{"type":"MemberExpression","start":751,"end":789,"loc":{"start":{"line":23,"column":36},"end":{"line":23,"column":74}},"object":{"type":"MemberExpression","start":751,"end":781,"loc":{"start":{"line":23,"column":36},"end":{"line":23,"column":66}},"object":{"type":"MemberExpression","start":751,"end":777,"loc":{"start":{"line":23,"column":36},"end":{"line":23,"column":62}},"object":{"type":"MemberExpression","start":751,"end":770,"loc":{"start":{"line":23,"column":36},"end":{"line":23,"column":55}},"object":{"type":"MemberExpression","start":751,"end":767,"loc":{"start":{"line":23,"column":36},"end":{"line":23,"column":52}},"object":{"type":"MemberExpression","start":751,"end":764,"loc":{"start":{"line":23,"column":36},"end":{"line":23,"column":49}},"object":{"type":"Identifier","start":751,"end":756,"loc":{"start":{"line":23,"column":36},"end":{"line":23,"column":41},"identifierName":"event"},"name":"event"},"property":{"type":"Identifier","start":757,"end":764,"loc":{"start":{"line":23,"column":42},"end":{"line":23,"column":49},"identifierName":"Records"},"name":"Records"},"computed":false},"property":{"type":"NumericLiteral","start":765,"end":766,"loc":{"start":{"line":23,"column":50},"end":{"line":23,"column":51}},"extra":{"rawValue":0,"raw":"0"},"value":0},"computed":true},"property":{"type":"Identifier","start":768,"end":770,"loc":{"start":{"line":23,"column":53},"end":{"line":23,"column":55},"identifierName":"s3"},"name":"s3"},"computed":false},"property":{"type":"Identifier","start":771,"end":777,"loc":{"start":{"line":23,"column":56},"end":{"line":23,"column":62},"identifierName":"object"},"name":"object"},"computed":false},"property":{"type":"Identifier","start":778,"end":781,"loc":{"start":{"line":23,"column":63},"end":{"line":23,"column":66},"identifierName":"key"},"name":"key"},"computed":false},"property":{"type":"Identifier","start":782,"end":789,"loc":{"start":{"line":23,"column":67},"end":{"line":23,"column":74},"identifierName":"replace"},"name":"replace"},"computed":false},"arguments":[{"type":"RegExpLiteral","start":790,"end":795,"loc":{"start":{"line":23,"column":75},"end":{"line":23,"column":80}},"extra":{"raw":"/\\+/g"},"pattern":"\\+","flags":"g"},{"type":"StringLiteral","start":797,"end":800,"loc":{"start":{"line":23,"column":82},"end":{"line":23,"column":85}},"extra":{"rawValue":" ","raw":"\" \""},"value":" "}]}]}}],"kind":"let"},{"type":"VariableDeclaration","start":808,"end":834,"loc":{"start":{"line":24,"column":4},"end":{"line":24,"column":30}},"declarations":[{"type":"VariableDeclarator","start":812,"end":833,"loc":{"start":{"line":24,"column":8},"end":{"line":24,"column":29}},"id":{"type":"Identifier","start":812,"end":821,"loc":{"start":{"line":24,"column":8},"end":{"line":24,"column":17},"identifierName":"dstBucket"},"name":"dstBucket"},"init":{"type":"Identifier","start":824,"end":833,"loc":{"start":{"line":24,"column":20},"end":{"line":24,"column":29},"identifierName":"srcBucket"},"name":"srcBucket"}}],"kind":"let"},{"type":"VariableDeclaration","start":839,"end":870,"loc":{"start":{"line":25,"column":4},"end":{"line":25,"column":35}},"declarations":[{"type":"VariableDeclarator","start":843,"end":869,"loc":{"start":{"line":25,"column":8},"end":{"line":25,"column":34}},"id":{"type":"Identifier","start":843,"end":849,"loc":{"start":{"line":25,"column":8},"end":{"line":25,"column":14},"identifierName":"dstKey"},"name":"dstKey"},"init":{"type":"BinaryExpression","start":852,"end":869,"loc":{"start":{"line":25,"column":17},"end":{"line":25,"column":34}},"left":{"type":"StringLiteral","start":852,"end":860,"loc":{"start":{"line":25,"column":17},"end":{"line":25,"column":25}},"extra":{"rawValue":"thumb-","raw":"\"thumb-\""},"value":"thumb-"},"operator":"+","right":{"type":"Identifier","start":863,"end":869,"loc":{"start":{"line":25,"column":28},"end":{"line":25,"column":34},"identifierName":"srcKey"},"name":"srcKey"}}}],"kind":"let","trailingComments":[{"type":"CommentLine","value":" Infer the image type.","start":876,"end":900,"loc":{"start":{"line":27,"column":4},"end":{"line":27,"column":28}}}]},{"type":"VariableDeclaration","start":905,"end":948,"loc":{"start":{"line":28,"column":4},"end":{"line":28,"column":47}},"declarations":[{"type":"VariableDeclarator","start":909,"end":947,"loc":{"start":{"line":28,"column":8},"end":{"line":28,"column":46}},"id":{"type":"Identifier","start":909,"end":918,"loc":{"start":{"line":28,"column":8},"end":{"line":28,"column":17},"identifierName":"typeMatch"},"name":"typeMatch","leadingComments":null},"init":{"type":"CallExpression","start":921,"end":947,"loc":{"start":{"line":28,"column":20},"end":{"line":28,"column":46}},"callee":{"type":"MemberExpression","start":921,"end":933,"loc":{"start":{"line":28,"column":20},"end":{"line":28,"column":32}},"object":{"type":"Identifier","start":921,"end":927,"loc":{"start":{"line":28,"column":20},"end":{"line":28,"column":26},"identifierName":"srcKey"},"name":"srcKey"},"property":{"type":"Identifier","start":928,"end":933,"loc":{"start":{"line":28,"column":27},"end":{"line":28,"column":32},"identifierName":"match"},"name":"match"},"computed":false},"arguments":[{"type":"RegExpLiteral","start":934,"end":946,"loc":{"start":{"line":28,"column":33},"end":{"line":28,"column":45}},"extra":{"raw":"/\\.([^.]*)$/"},"pattern":"\\.([^.]*)$","flags":""}]},"leadingComments":null}],"kind":"let","leadingComments":[{"type":"CommentLine","value":" Infer the image type.","start":876,"end":900,"loc":{"start":{"line":27,"column":4},"end":{"line":27,"column":28}}}]},{"type":"IfStatement","start":953,"end":1049,"loc":{"start":{"line":29,"column":4},"end":{"line":32,"column":5}},"test":{"type":"UnaryExpression","start":957,"end":967,"loc":{"start":{"line":29,"column":8},"end":{"line":29,"column":18}},"operator":"!","prefix":true,"argument":{"type":"Identifier","start":958,"end":967,"loc":{"start":{"line":29,"column":9},"end":{"line":29,"column":18},"identifierName":"typeMatch"},"name":"typeMatch"},"extra":{"parenthesizedArgument":false}},"consequent":{"type":"BlockStatement","start":969,"end":1049,"loc":{"start":{"line":29,"column":20},"end":{"line":32,"column":5}},"body":[{"type":"ExpressionStatement","start":979,"end":1027,"loc":{"start":{"line":30,"column":8},"end":{"line":30,"column":56}},"expression":{"type":"CallExpression","start":979,"end":1026,"loc":{"start":{"line":30,"column":8},"end":{"line":30,"column":55}},"callee":{"type":"Identifier","start":979,"end":987,"loc":{"start":{"line":30,"column":8},"end":{"line":30,"column":16},"identifierName":"callback"},"name":"callback"},"arguments":[{"type":"StringLiteral","start":988,"end":1025,"loc":{"start":{"line":30,"column":17},"end":{"line":30,"column":54}},"extra":{"rawValue":"Could not determine the image type.","raw":"\"Could not determine the image type.\""},"value":"Could not determine the image type."}]}},{"type":"ReturnStatement","start":1036,"end":1043,"loc":{"start":{"line":31,"column":8},"end":{"line":31,"column":15}},"argument":null}],"directives":[]},"alternate":null},{"type":"VariableDeclaration","start":1054,"end":1083,"loc":{"start":{"line":33,"column":4},"end":{"line":33,"column":33}},"declarations":[{"type":"VariableDeclarator","start":1058,"end":1082,"loc":{"start":{"line":33,"column":8},"end":{"line":33,"column":32}},"id":{"type":"Identifier","start":1058,"end":1067,"loc":{"start":{"line":33,"column":8},"end":{"line":33,"column":17},"identifierName":"imageType"},"name":"imageType"},"init":{"type":"MemberExpression","start":1070,"end":1082,"loc":{"start":{"line":33,"column":20},"end":{"line":33,"column":32}},"object":{"type":"Identifier","start":1070,"end":1079,"loc":{"start":{"line":33,"column":20},"end":{"line":33,"column":29},"identifierName":"typeMatch"},"name":"typeMatch"},"property":{"type":"NumericLiteral","start":1080,"end":1081,"loc":{"start":{"line":33,"column":30},"end":{"line":33,"column":31}},"extra":{"rawValue":1,"raw":"1"},"value":1},"computed":true}}],"kind":"let"},{"type":"IfStatement","start":1088,"end":1215,"loc":{"start":{"line":34,"column":4},"end":{"line":37,"column":5}},"test":{"type":"LogicalExpression","start":1092,"end":1132,"loc":{"start":{"line":34,"column":8},"end":{"line":34,"column":48}},"left":{"type":"BinaryExpression","start":1092,"end":1110,"loc":{"start":{"line":34,"column":8},"end":{"line":34,"column":26}},"left":{"type":"Identifier","start":1092,"end":1101,"loc":{"start":{"line":34,"column":8},"end":{"line":34,"column":17},"identifierName":"imageType"},"name":"imageType"},"operator":"!=","right":{"type":"StringLiteral","start":1105,"end":1110,"loc":{"start":{"line":34,"column":21},"end":{"line":34,"column":26}},"extra":{"rawValue":"jpg","raw":"\"jpg\""},"value":"jpg"}},"operator":"&&","right":{"type":"BinaryExpression","start":1114,"end":1132,"loc":{"start":{"line":34,"column":30},"end":{"line":34,"column":48}},"left":{"type":"Identifier","start":1114,"end":1123,"loc":{"start":{"line":34,"column":30},"end":{"line":34,"column":39},"identifierName":"imageType"},"name":"imageType"},"operator":"!=","right":{"type":"StringLiteral","start":1127,"end":1132,"loc":{"start":{"line":34,"column":43},"end":{"line":34,"column":48}},"extra":{"rawValue":"png","raw":"\"png\""},"value":"png"}}},"consequent":{"type":"BlockStatement","start":1134,"end":1215,"loc":{"start":{"line":34,"column":50},"end":{"line":37,"column":5}},"body":[{"type":"ExpressionStatement","start":1144,"end":1193,"loc":{"start":{"line":35,"column":8},"end":{"line":35,"column":57}},"expression":{"type":"CallExpression","start":1144,"end":1192,"loc":{"start":{"line":35,"column":8},"end":{"line":35,"column":56}},"callee":{"type":"Identifier","start":1144,"end":1152,"loc":{"start":{"line":35,"column":8},"end":{"line":35,"column":16},"identifierName":"callback"},"name":"callback"},"arguments":[{"type":"TemplateLiteral","start":1153,"end":1191,"loc":{"start":{"line":35,"column":17},"end":{"line":35,"column":55}},"expressions":[{"type":"Identifier","start":1180,"end":1189,"loc":{"start":{"line":35,"column":44},"end":{"line":35,"column":53},"identifierName":"imageType"},"name":"imageType"}],"quasis":[{"type":"TemplateElement","start":1154,"end":1178,"loc":{"start":{"line":35,"column":18},"end":{"line":35,"column":42}},"value":{"raw":"Unsupported image type: ","cooked":"Unsupported image type: "},"tail":false},{"type":"TemplateElement","start":1190,"end":1190,"loc":{"start":{"line":35,"column":54},"end":{"line":35,"column":54}},"value":{"raw":"","cooked":""},"tail":true}]}]}},{"type":"ReturnStatement","start":1202,"end":1209,"loc":{"start":{"line":36,"column":8},"end":{"line":36,"column":15}},"argument":null}],"directives":[],"trailingComments":null},"alternate":null,"trailingComments":[{"type":"CommentLine","value":" Download the image from S3, transform, and upload under new key.","start":1221,"end":1288,"loc":{"start":{"line":39,"column":4},"end":{"line":39,"column":71}}}]},{"type":"ExpressionStatement","start":1293,"end":3144,"loc":{"start":{"line":40,"column":4},"end":{"line":89,"column":6}},"expression":{"type":"CallExpression","start":1293,"end":3143,"loc":{"start":{"line":40,"column":4},"end":{"line":89,"column":5}},"callee":{"type":"MemberExpression","start":1293,"end":1308,"loc":{"start":{"line":40,"column":4},"end":{"line":40,"column":19}},"object":{"type":"Identifier","start":1293,"end":1298,"loc":{"start":{"line":40,"column":4},"end":{"line":40,"column":9},"identifierName":"async"},"name":"async","leadingComments":null},"property":{"type":"Identifier","start":1299,"end":1308,"loc":{"start":{"line":40,"column":10},"end":{"line":40,"column":19},"identifierName":"waterfall"},"name":"waterfall"},"computed":false,"leadingComments":null},"arguments":[{"type":"ArrayExpression","start":1309,"end":2734,"loc":{"start":{"line":40,"column":20},"end":{"line":78,"column":5}},"elements":[{"type":"FunctionExpression","start":1319,"end":1527,"loc":{"start":{"line":41,"column":8},"end":{"line":47,"column":9}},"id":{"type":"Identifier","start":1328,"end":1336,"loc":{"start":{"line":41,"column":17},"end":{"line":41,"column":25},"identifierName":"download"},"name":"download"},"generator":false,"async":false,"params":[{"type":"Identifier","start":1337,"end":1341,"loc":{"start":{"line":41,"column":26},"end":{"line":41,"column":30},"identifierName":"next"},"name":"next"}],"body":{"type":"BlockStatement","start":1343,"end":1527,"loc":{"start":{"line":41,"column":32},"end":{"line":47,"column":9}},"body":[{"type":"ExpressionStatement","start":1414,"end":1517,"loc":{"start":{"line":43,"column":12},"end":{"line":46,"column":21}},"expression":{"type":"CallExpression","start":1414,"end":1516,"loc":{"start":{"line":43,"column":12},"end":{"line":46,"column":20}},"callee":{"type":"MemberExpression","start":1414,"end":1426,"loc":{"start":{"line":43,"column":12},"end":{"line":43,"column":24}},"object":{"type":"Identifier","start":1414,"end":1416,"loc":{"start":{"line":43,"column":12},"end":{"line":43,"column":14},"identifierName":"s3"},"name":"s3","leadingComments":null},"property":{"type":"Identifier","start":1417,"end":1426,"loc":{"start":{"line":43,"column":15},"end":{"line":43,"column":24},"identifierName":"getObject"},"name":"getObject"},"computed":false,"leadingComments":null},"arguments":[{"type":"ObjectExpression","start":1427,"end":1509,"loc":{"start":{"line":43,"column":25},"end":{"line":46,"column":13}},"properties":[{"type":"ObjectProperty","start":1445,"end":1464,"loc":{"start":{"line":44,"column":16},"end":{"line":44,"column":35}},"method":false,"key":{"type":"StringLiteral","start":1445,"end":1453,"loc":{"start":{"line":44,"column":16},"end":{"line":44,"column":24}},"extra":{"rawValue":"Bucket","raw":"'Bucket'"},"value":"Bucket"},"computed":false,"shorthand":false,"value":{"type":"Identifier","start":1455,"end":1464,"loc":{"start":{"line":44,"column":26},"end":{"line":44,"column":35},"identifierName":"srcBucket"},"name":"srcBucket"}},{"type":"ObjectProperty","start":1482,"end":1495,"loc":{"start":{"line":45,"column":16},"end":{"line":45,"column":29}},"method":false,"key":{"type":"StringLiteral","start":1482,"end":1487,"loc":{"start":{"line":45,"column":16},"end":{"line":45,"column":21}},"extra":{"rawValue":"Key","raw":"'Key'"},"value":"Key"},"computed":false,"shorthand":false,"value":{"type":"Identifier","start":1489,"end":1495,"loc":{"start":{"line":45,"column":23},"end":{"line":45,"column":29},"identifierName":"srcKey"},"name":"srcKey"}}]},{"type":"Identifier","start":1511,"end":1515,"loc":{"start":{"line":46,"column":15},"end":{"line":46,"column":19},"identifierName":"next"},"name":"next"}],"leadingComments":null},"leadingComments":[{"type":"CommentLine","value":" Download the image from S3 into a buffer.","start":1357,"end":1401,"loc":{"start":{"line":42,"column":12},"end":{"line":42,"column":56}}}]}],"directives":[]}},{"type":"FunctionExpression","start":1537,"end":2406,"loc":{"start":{"line":48,"column":8},"end":{"line":68,"column":9}},"id":{"type":"Identifier","start":1546,"end":1555,"loc":{"start":{"line":48,"column":17},"end":{"line":48,"column":26},"identifierName":"transform"},"name":"transform"},"generator":false,"async":false,"params":[{"type":"Identifier","start":1556,"end":1564,"loc":{"start":{"line":48,"column":27},"end":{"line":48,"column":35},"identifierName":"response"},"name":"response"},{"type":"Identifier","start":1566,"end":1570,"loc":{"start":{"line":48,"column":37},"end":{"line":48,"column":41},"identifierName":"next"},"name":"next"}],"body":{"type":"BlockStatement","start":1572,"end":2406,"loc":{"start":{"line":48,"column":43},"end":{"line":68,"column":9}},"body":[{"type":"ExpressionStatement","start":1586,"end":2396,"loc":{"start":{"line":49,"column":12},"end":{"line":67,"column":15}},"expression":{"type":"CallExpression","start":1586,"end":2395,"loc":{"start":{"line":49,"column":12},"end":{"line":67,"column":14}},"callee":{"type":"MemberExpression","start":1586,"end":1608,"loc":{"start":{"line":49,"column":12},"end":{"line":49,"column":34}},"object":{"type":"CallExpression","start":1586,"end":1603,"loc":{"start":{"line":49,"column":12},"end":{"line":49,"column":29}},"callee":{"type":"Identifier","start":1586,"end":1588,"loc":{"start":{"line":49,"column":12},"end":{"line":49,"column":14},"identifierName":"gm"},"name":"gm"},"arguments":[{"type":"MemberExpression","start":1589,"end":1602,"loc":{"start":{"line":49,"column":15},"end":{"line":49,"column":28}},"object":{"type":"Identifier","start":1589,"end":1597,"loc":{"start":{"line":49,"column":15},"end":{"line":49,"column":23},"identifierName":"response"},"name":"response"},"property":{"type":"Identifier","start":1598,"end":1602,"loc":{"start":{"line":49,"column":24},"end":{"line":49,"column":28},"identifierName":"Body"},"name":"Body"},"computed":false}]},"property":{"type":"Identifier","start":1604,"end":1608,"loc":{"start":{"line":49,"column":30},"end":{"line":49,"column":34},"identifierName":"size"},"name":"size"},"computed":false},"arguments":[{"type":"FunctionExpression","start":1609,"end":2394,"loc":{"start":{"line":49,"column":35},"end":{"line":67,"column":13}},"id":null,"generator":false,"async":false,"params":[{"type":"Identifier","start":1619,"end":1622,"loc":{"start":{"line":49,"column":45},"end":{"line":49,"column":48},"identifierName":"err"},"name":"err"},{"type":"Identifier","start":1624,"end":1628,"loc":{"start":{"line":49,"column":50},"end":{"line":49,"column":54},"identifierName":"size"},"name":"size"}],"body":{"type":"BlockStatement","start":1630,"end":2394,"loc":{"start":{"line":49,"column":56},"end":{"line":67,"column":13}},"body":[{"type":"VariableDeclaration","start":1735,"end":1872,"loc":{"start":{"line":51,"column":16},"end":{"line":54,"column":18}},"declarations":[{"type":"VariableDeclarator","start":1739,"end":1871,"loc":{"start":{"line":51,"column":20},"end":{"line":54,"column":17}},"id":{"type":"Identifier","start":1739,"end":1752,"loc":{"start":{"line":51,"column":20},"end":{"line":51,"column":33},"identifierName":"scalingFactor"},"name":"scalingFactor","leadingComments":null},"init":{"type":"CallExpression","start":1755,"end":1871,"loc":{"start":{"line":51,"column":36},"end":{"line":54,"column":17}},"callee":{"type":"MemberExpression","start":1755,"end":1763,"loc":{"start":{"line":51,"column":36},"end":{"line":51,"column":44}},"object":{"type":"Identifier","start":1755,"end":1759,"loc":{"start":{"line":51,"column":36},"end":{"line":51,"column":40},"identifierName":"Math"},"name":"Math"},"property":{"type":"Identifier","start":1760,"end":1763,"loc":{"start":{"line":51,"column":41},"end":{"line":51,"column":44},"identifierName":"min"},"name":"min"},"computed":false},"arguments":[{"type":"BinaryExpression","start":1785,"end":1807,"loc":{"start":{"line":52,"column":20},"end":{"line":52,"column":42}},"left":{"type":"Identifier","start":1785,"end":1794,"loc":{"start":{"line":52,"column":20},"end":{"line":52,"column":29},"identifierName":"MAX_WIDTH"},"name":"MAX_WIDTH"},"operator":"/","right":{"type":"MemberExpression","start":1797,"end":1807,"loc":{"start":{"line":52,"column":32},"end":{"line":52,"column":42}},"object":{"type":"Identifier","start":1797,"end":1801,"loc":{"start":{"line":52,"column":32},"end":{"line":52,"column":36},"identifierName":"size"},"name":"size"},"property":{"type":"Identifier","start":1802,"end":1807,"loc":{"start":{"line":52,"column":37},"end":{"line":52,"column":42},"identifierName":"width"},"name":"width"},"computed":false}},{"type":"BinaryExpression","start":1829,"end":1853,"loc":{"start":{"line":53,"column":20},"end":{"line":53,"column":44}},"left":{"type":"Identifier","start":1829,"end":1839,"loc":{"start":{"line":53,"column":20},"end":{"line":53,"column":30},"identifierName":"MAX_HEIGHT"},"name":"MAX_HEIGHT"},"operator":"/","right":{"type":"MemberExpression","start":1842,"end":1853,"loc":{"start":{"line":53,"column":33},"end":{"line":53,"column":44}},"object":{"type":"Identifier","start":1842,"end":1846,"loc":{"start":{"line":53,"column":33},"end":{"line":53,"column":37},"identifierName":"size"},"name":"size"},"property":{"type":"Identifier","start":1847,"end":1853,"loc":{"start":{"line":53,"column":38},"end":{"line":53,"column":44},"identifierName":"height"},"name":"height"},"computed":false}}]},"leadingComments":null}],"kind":"let","leadingComments":[{"type":"CommentLine","value":" Infer the scaling factor to avoid stretching the image unnaturally.","start":1648,"end":1718,"loc":{"start":{"line":50,"column":16},"end":{"line":50,"column":86}}}]},{"type":"VariableDeclaration","start":1889,"end":1928,"loc":{"start":{"line":55,"column":16},"end":{"line":55,"column":55}},"declarations":[{"type":"VariableDeclarator","start":1893,"end":1927,"loc":{"start":{"line":55,"column":20},"end":{"line":55,"column":54}},"id":{"type":"Identifier","start":1893,"end":1898,"loc":{"start":{"line":55,"column":20},"end":{"line":55,"column":25},"identifierName":"width"},"name":"width"},"init":{"type":"BinaryExpression","start":1901,"end":1927,"loc":{"start":{"line":55,"column":28},"end":{"line":55,"column":54}},"left":{"type":"Identifier","start":1901,"end":1914,"loc":{"start":{"line":55,"column":28},"end":{"line":55,"column":41},"identifierName":"scalingFactor"},"name":"scalingFactor"},"operator":"*","right":{"type":"MemberExpression","start":1917,"end":1927,"loc":{"start":{"line":55,"column":44},"end":{"line":55,"column":54}},"object":{"type":"Identifier","start":1917,"end":1921,"loc":{"start":{"line":55,"column":44},"end":{"line":55,"column":48},"identifierName":"size"},"name":"size"},"property":{"type":"Identifier","start":1922,"end":1927,"loc":{"start":{"line":55,"column":49},"end":{"line":55,"column":54},"identifierName":"width"},"name":"width"},"computed":false}}}],"kind":"let"},{"type":"VariableDeclaration","start":1945,"end":1986,"loc":{"start":{"line":56,"column":16},"end":{"line":56,"column":57}},"declarations":[{"type":"VariableDeclarator","start":1949,"end":1985,"loc":{"start":{"line":56,"column":20},"end":{"line":56,"column":56}},"id":{"type":"Identifier","start":1949,"end":1955,"loc":{"start":{"line":56,"column":20},"end":{"line":56,"column":26},"identifierName":"height"},"name":"height"},"init":{"type":"BinaryExpression","start":1958,"end":1985,"loc":{"start":{"line":56,"column":29},"end":{"line":56,"column":56}},"left":{"type":"Identifier","start":1958,"end":1971,"loc":{"start":{"line":56,"column":29},"end":{"line":56,"column":42},"identifierName":"scalingFactor"},"name":"scalingFactor"},"operator":"*","right":{"type":"MemberExpression","start":1974,"end":1985,"loc":{"start":{"line":56,"column":45},"end":{"line":56,"column":56}},"object":{"type":"Identifier","start":1974,"end":1978,"loc":{"start":{"line":56,"column":45},"end":{"line":56,"column":49},"identifierName":"size"},"name":"size"},"property":{"type":"Identifier","start":1979,"end":1985,"loc":{"start":{"line":56,"column":50},"end":{"line":56,"column":56},"identifierName":"height"},"name":"height"},"computed":false}}}],"kind":"let","trailingComments":[{"type":"CommentLine","value":" Transform the image buffer in memory.","start":2004,"end":2044,"loc":{"start":{"line":58,"column":16},"end":{"line":58,"column":56}}}]},{"type":"ExpressionStatement","start":2061,"end":2380,"loc":{"start":{"line":59,"column":16},"end":{"line":66,"column":23}},"expression":{"type":"CallExpression","start":2061,"end":2379,"loc":{"start":{"line":59,"column":16},"end":{"line":66,"column":22}},"callee":{"type":"MemberExpression","start":2061,"end":2117,"loc":{"start":{"line":59,"column":16},"end":{"line":60,"column":29}},"object":{"type":"CallExpression","start":2061,"end":2087,"loc":{"start":{"line":59,"column":16},"end":{"line":59,"column":42}},"callee":{"type":"MemberExpression","start":2061,"end":2072,"loc":{"start":{"line":59,"column":16},"end":{"line":59,"column":27}},"object":{"type":"ThisExpression","start":2061,"end":2065,"loc":{"start":{"line":59,"column":16},"end":{"line":59,"column":20}},"leadingComments":null},"property":{"type":"Identifier","start":2066,"end":2072,"loc":{"start":{"line":59,"column":21},"end":{"line":59,"column":27},"identifierName":"resize"},"name":"resize"},"computed":false,"leadingComments":null},"arguments":[{"type":"Identifier","start":2073,"end":2078,"loc":{"start":{"line":59,"column":28},"end":{"line":59,"column":33},"identifierName":"width"},"name":"width"},{"type":"Identifier","start":2080,"end":2086,"loc":{"start":{"line":59,"column":35},"end":{"line":59,"column":41},"identifierName":"height"},"name":"height"}],"leadingComments":null},"property":{"type":"Identifier","start":2109,"end":2117,"loc":{"start":{"line":60,"column":21},"end":{"line":60,"column":29},"identifierName":"toBuffer"},"name":"toBuffer"},"computed":false,"leadingComments":null},"arguments":[{"type":"Identifier","start":2118,"end":2127,"loc":{"start":{"line":60,"column":30},"end":{"line":60,"column":39},"identifierName":"imageType"},"name":"imageType"},{"type":"FunctionExpression","start":2129,"end":2378,"loc":{"start":{"line":60,"column":41},"end":{"line":66,"column":21}},"id":null,"generator":false,"async":false,"params":[{"type":"Identifier","start":2139,"end":2142,"loc":{"start":{"line":60,"column":51},"end":{"line":60,"column":54},"identifierName":"err"},"name":"err"},{"type":"Identifier","start":2144,"end":2150,"loc":{"start":{"line":60,"column":56},"end":{"line":60,"column":62},"identifierName":"buffer"},"name":"buffer"}],"body":{"type":"BlockStatement","start":2152,"end":2378,"loc":{"start":{"line":60,"column":64},"end":{"line":66,"column":21}},"body":[{"type":"IfStatement","start":2178,"end":2356,"loc":{"start":{"line":61,"column":24},"end":{"line":65,"column":25}},"test":{"type":"Identifier","start":2182,"end":2185,"loc":{"start":{"line":61,"column":28},"end":{"line":61,"column":31},"identifierName":"err"},"name":"err"},"consequent":{"type":"BlockStatement","start":2187,"end":2253,"loc":{"start":{"line":61,"column":33},"end":{"line":63,"column":25}},"body":[{"type":"ExpressionStatement","start":2217,"end":2227,"loc":{"start":{"line":62,"column":28},"end":{"line":62,"column":38}},"expression":{"type":"CallExpression","start":2217,"end":2226,"loc":{"start":{"line":62,"column":28},"end":{"line":62,"column":37}},"callee":{"type":"Identifier","start":2217,"end":2221,"loc":{"start":{"line":62,"column":28},"end":{"line":62,"column":32},"identifierName":"next"},"name":"next"},"arguments":[{"type":"Identifier","start":2222,"end":2225,"loc":{"start":{"line":62,"column":33},"end":{"line":62,"column":36},"identifierName":"err"},"name":"err"}]}}],"directives":[]},"alternate":{"type":"BlockStatement","start":2259,"end":2356,"loc":{"start":{"line":63,"column":31},"end":{"line":65,"column":25}},"body":[{"type":"ExpressionStatement","start":2289,"end":2330,"loc":{"start":{"line":64,"column":28},"end":{"line":64,"column":69}},"expression":{"type":"CallExpression","start":2289,"end":2329,"loc":{"start":{"line":64,"column":28},"end":{"line":64,"column":68}},"callee":{"type":"Identifier","start":2289,"end":2293,"loc":{"start":{"line":64,"column":28},"end":{"line":64,"column":32},"identifierName":"next"},"name":"next"},"arguments":[{"type":"NullLiteral","start":2294,"end":2298,"loc":{"start":{"line":64,"column":33},"end":{"line":64,"column":37}}},{"type":"MemberExpression","start":2300,"end":2320,"loc":{"start":{"line":64,"column":39},"end":{"line":64,"column":59}},"object":{"type":"Identifier","start":2300,"end":2308,"loc":{"start":{"line":64,"column":39},"end":{"line":64,"column":47},"identifierName":"response"},"name":"response"},"property":{"type":"Identifier","start":2309,"end":2320,"loc":{"start":{"line":64,"column":48},"end":{"line":64,"column":59},"identifierName":"ContentType"},"name":"ContentType"},"computed":false},{"type":"Identifier","start":2322,"end":2328,"loc":{"start":{"line":64,"column":61},"end":{"line":64,"column":67},"identifierName":"buffer"},"name":"buffer"}]}}],"directives":[]}}],"directives":[]}}],"leadingComments":null},"leadingComments":[{"type":"CommentLine","value":" Transform the image buffer in memory.","start":2004,"end":2044,"loc":{"start":{"line":58,"column":16},"end":{"line":58,"column":56}}}]}],"directives":[]}}]}}],"directives":[]}},{"type":"FunctionExpression","start":2416,"end":2728,"loc":{"start":{"line":69,"column":8},"end":{"line":77,"column":9}},"id":{"type":"Identifier","start":2425,"end":2431,"loc":{"start":{"line":69,"column":17},"end":{"line":69,"column":23},"identifierName":"upload"},"name":"upload"},"generator":false,"async":false,"params":[{"type":"Identifier","start":2432,"end":2443,"loc":{"start":{"line":69,"column":24},"end":{"line":69,"column":35},"identifierName":"contentType"},"name":"contentType"},{"type":"Identifier","start":2445,"end":2449,"loc":{"start":{"line":69,"column":37},"end":{"line":69,"column":41},"identifierName":"data"},"name":"data"},{"type":"Identifier","start":2451,"end":2455,"loc":{"start":{"line":69,"column":43},"end":{"line":69,"column":47},"identifierName":"next"},"name":"next"}],"body":{"type":"BlockStatement","start":2457,"end":2728,"loc":{"start":{"line":69,"column":49},"end":{"line":77,"column":9}},"body":[{"type":"ExpressionStatement","start":2541,"end":2718,"loc":{"start":{"line":71,"column":12},"end":{"line":76,"column":21}},"expression":{"type":"CallExpression","start":2541,"end":2717,"loc":{"start":{"line":71,"column":12},"end":{"line":76,"column":20}},"callee":{"type":"MemberExpression","start":2541,"end":2553,"loc":{"start":{"line":71,"column":12},"end":{"line":71,"column":24}},"object":{"type":"Identifier","start":2541,"end":2543,"loc":{"start":{"line":71,"column":12},"end":{"line":71,"column":14},"identifierName":"s3"},"name":"s3","leadingComments":null},"property":{"type":"Identifier","start":2544,"end":2553,"loc":{"start":{"line":71,"column":15},"end":{"line":71,"column":24},"identifierName":"putObject"},"name":"putObject"},"computed":false,"leadingComments":null},"arguments":[{"type":"ObjectExpression","start":2554,"end":2710,"loc":{"start":{"line":71,"column":25},"end":{"line":76,"column":13}},"properties":[{"type":"ObjectProperty","start":2572,"end":2584,"loc":{"start":{"line":72,"column":16},"end":{"line":72,"column":28}},"method":false,"key":{"type":"StringLiteral","start":2572,"end":2578,"loc":{"start":{"line":72,"column":16},"end":{"line":72,"column":22}},"extra":{"rawValue":"Body","raw":"\"Body\""},"value":"Body"},"computed":false,"shorthand":false,"value":{"type":"Identifier","start":2580,"end":2584,"loc":{"start":{"line":72,"column":24},"end":{"line":72,"column":28},"identifierName":"data"},"name":"data"}},{"type":"ObjectProperty","start":2602,"end":2621,"loc":{"start":{"line":73,"column":16},"end":{"line":73,"column":35}},"method":false,"key":{"type":"StringLiteral","start":2602,"end":2610,"loc":{"start":{"line":73,"column":16},"end":{"line":73,"column":24}},"extra":{"rawValue":"Bucket","raw":"\"Bucket\""},"value":"Bucket"},"computed":false,"shorthand":false,"value":{"type":"Identifier","start":2612,"end":2621,"loc":{"start":{"line":73,"column":26},"end":{"line":73,"column":35},"identifierName":"dstBucket"},"name":"dstBucket"}},{"type":"ObjectProperty","start":2639,"end":2652,"loc":{"start":{"line":74,"column":16},"end":{"line":74,"column":29}},"method":false,"key":{"type":"StringLiteral","start":2639,"end":2644,"loc":{"start":{"line":74,"column":16},"end":{"line":74,"column":21}},"extra":{"rawValue":"Key","raw":"\"Key\""},"value":"Key"},"computed":false,"shorthand":false,"value":{"type":"Identifier","start":2646,"end":2652,"loc":{"start":{"line":74,"column":23},"end":{"line":74,"column":29},"identifierName":"dstKey"},"name":"dstKey"}},{"type":"ObjectProperty","start":2670,"end":2696,"loc":{"start":{"line":75,"column":16},"end":{"line":75,"column":42}},"method":false,"key":{"type":"StringLiteral","start":2670,"end":2683,"loc":{"start":{"line":75,"column":16},"end":{"line":75,"column":29}},"extra":{"rawValue":"ContentType","raw":"\"ContentType\""},"value":"ContentType"},"computed":false,"shorthand":false,"value":{"type":"Identifier","start":2685,"end":2696,"loc":{"start":{"line":75,"column":31},"end":{"line":75,"column":42},"identifierName":"contentType"},"name":"contentType"}}]},{"type":"Identifier","start":2712,"end":2716,"loc":{"start":{"line":76,"column":15},"end":{"line":76,"column":19},"identifierName":"next"},"name":"next"}],"leadingComments":null},"leadingComments":[{"type":"CommentLine","value":" Stream the transformed image to a different S3 bucket.","start":2471,"end":2528,"loc":{"start":{"line":70,"column":12},"end":{"line":70,"column":69}}}]}],"directives":[]}}]},{"type":"FunctionExpression","start":2736,"end":3137,"loc":{"start":{"line":78,"column":7},"end":{"line":88,"column":5}},"id":null,"generator":false,"async":false,"params":[{"type":"Identifier","start":2746,"end":2749,"loc":{"start":{"line":78,"column":17},"end":{"line":78,"column":20},"identifierName":"err"},"name":"err"}],"body":{"type":"BlockStatement","start":2751,"end":3137,"loc":{"start":{"line":78,"column":22},"end":{"line":88,"column":5}},"body":[{"type":"VariableDeclaration","start":2761,"end":2769,"loc":{"start":{"line":79,"column":8},"end":{"line":79,"column":16}},"declarations":[{"type":"VariableDeclarator","start":2765,"end":2768,"loc":{"start":{"line":79,"column":12},"end":{"line":79,"column":15}},"id":{"type":"Identifier","start":2765,"end":2768,"loc":{"start":{"line":79,"column":12},"end":{"line":79,"column":15},"identifierName":"msg"},"name":"msg"},"init":null}],"kind":"let"},{"type":"IfStatement","start":2778,"end":3103,"loc":{"start":{"line":80,"column":8},"end":{"line":86,"column":9}},"test":{"type":"Identifier","start":2782,"end":2785,"loc":{"start":{"line":80,"column":12},"end":{"line":80,"column":15},"identifierName":"err"},"name":"err"},"consequent":{"type":"BlockStatement","start":2787,"end":2952,"loc":{"start":{"line":80,"column":17},"end":{"line":83,"column":9}},"body":[{"type":"ExpressionStatement","start":2801,"end":2910,"loc":{"start":{"line":81,"column":12},"end":{"line":81,"column":121}},"expression":{"type":"AssignmentExpression","start":2801,"end":2909,"loc":{"start":{"line":81,"column":12},"end":{"line":81,"column":120}},"operator":"=","left":{"type":"Identifier","start":2801,"end":2804,"loc":{"start":{"line":81,"column":12},"end":{"line":81,"column":15},"identifierName":"msg"},"name":"msg"},"right":{"type":"TemplateLiteral","start":2807,"end":2909,"loc":{"start":{"line":81,"column":18},"end":{"line":81,"column":120}},"expressions":[{"type":"Identifier","start":2827,"end":2836,"loc":{"start":{"line":81,"column":38},"end":{"line":81,"column":47},"identifierName":"srcBucket"},"name":"srcBucket"},{"type":"Identifier","start":2840,"end":2846,"loc":{"start":{"line":81,"column":51},"end":{"line":81,"column":57},"identifierName":"srcKey"},"name":"srcKey"},{"type":"Identifier","start":2864,"end":2873,"loc":{"start":{"line":81,"column":75},"end":{"line":81,"column":84},"identifierName":"dstBucket"},"name":"dstBucket"},{"type":"Identifier","start":2877,"end":2883,"loc":{"start":{"line":81,"column":88},"end":{"line":81,"column":94},"identifierName":"dstKey"},"name":"dstKey"},{"type":"Identifier","start":2904,"end":2907,"loc":{"start":{"line":81,"column":115},"end":{"line":81,"column":118},"identifierName":"err"},"name":"err"}],"quasis":[{"type":"TemplateElement","start":2808,"end":2825,"loc":{"start":{"line":81,"column":19},"end":{"line":81,"column":36}},"value":{"raw":"Unable to resize ","cooked":"Unable to resize "},"tail":false},{"type":"TemplateElement","start":2837,"end":2838,"loc":{"start":{"line":81,"column":48},"end":{"line":81,"column":49}},"value":{"raw":"/","cooked":"/"},"tail":false},{"type":"TemplateElement","start":2847,"end":2862,"loc":{"start":{"line":81,"column":58},"end":{"line":81,"column":73}},"value":{"raw":" and upload to ","cooked":" and upload to "},"tail":false},{"type":"TemplateElement","start":2874,"end":2875,"loc":{"start":{"line":81,"column":85},"end":{"line":81,"column":86}},"value":{"raw":"/","cooked":"/"},"tail":false},{"type":"TemplateElement","start":2884,"end":2902,"loc":{"start":{"line":81,"column":95},"end":{"line":81,"column":113}},"value":{"raw":" due to an error: ","cooked":" due to an error: "},"tail":false},{"type":"TemplateElement","start":2908,"end":2908,"loc":{"start":{"line":81,"column":119},"end":{"line":81,"column":119}},"value":{"raw":"","cooked":""},"tail":true}]}}},{"type":"ExpressionStatement","start":2923,"end":2942,"loc":{"start":{"line":82,"column":12},"end":{"line":82,"column":31}},"expression":{"type":"CallExpression","start":2923,"end":2941,"loc":{"start":{"line":82,"column":12},"end":{"line":82,"column":30}},"callee":{"type":"MemberExpression","start":2923,"end":2936,"loc":{"start":{"line":82,"column":12},"end":{"line":82,"column":25}},"object":{"type":"Identifier","start":2923,"end":2930,"loc":{"start":{"line":82,"column":12},"end":{"line":82,"column":19},"identifierName":"console"},"name":"console"},"property":{"type":"Identifier","start":2931,"end":2936,"loc":{"start":{"line":82,"column":20},"end":{"line":82,"column":25},"identifierName":"error"},"name":"error"},"computed":false},"arguments":[{"type":"Identifier","start":2937,"end":2940,"loc":{"start":{"line":82,"column":26},"end":{"line":82,"column":29},"identifierName":"msg"},"name":"msg"}]}}],"directives":[]},"alternate":{"type":"BlockStatement","start":2958,"end":3103,"loc":{"start":{"line":83,"column":15},"end":{"line":86,"column":9}},"body":[{"type":"ExpressionStatement","start":2972,"end":3063,"loc":{"start":{"line":84,"column":12},"end":{"line":84,"column":103}},"expression":{"type":"AssignmentExpression","start":2972,"end":3062,"loc":{"start":{"line":84,"column":12},"end":{"line":84,"column":102}},"operator":"=","left":{"type":"Identifier","start":2972,"end":2975,"loc":{"start":{"line":84,"column":12},"end":{"line":84,"column":15},"identifierName":"msg"},"name":"msg"},"right":{"type":"TemplateLiteral","start":2978,"end":3062,"loc":{"start":{"line":84,"column":18},"end":{"line":84,"column":102}},"expressions":[{"type":"Identifier","start":3002,"end":3011,"loc":{"start":{"line":84,"column":42},"end":{"line":84,"column":51},"identifierName":"srcBucket"},"name":"srcBucket"},{"type":"Identifier","start":3015,"end":3021,"loc":{"start":{"line":84,"column":55},"end":{"line":84,"column":61},"identifierName":"srcKey"},"name":"srcKey"},{"type":"Identifier","start":3041,"end":3050,"loc":{"start":{"line":84,"column":81},"end":{"line":84,"column":90},"identifierName":"dstBucket"},"name":"dstBucket"},{"type":"Identifier","start":3054,"end":3060,"loc":{"start":{"line":84,"column":94},"end":{"line":84,"column":100},"identifierName":"dstKey"},"name":"dstKey"}],"quasis":[{"type":"TemplateElement","start":2979,"end":3000,"loc":{"start":{"line":84,"column":19},"end":{"line":84,"column":40}},"value":{"raw":"Successfully resized ","cooked":"Successfully resized "},"tail":false},{"type":"TemplateElement","start":3012,"end":3013,"loc":{"start":{"line":84,"column":52},"end":{"line":84,"column":53}},"value":{"raw":"/","cooked":"/"},"tail":false},{"type":"TemplateElement","start":3022,"end":3039,"loc":{"start":{"line":84,"column":62},"end":{"line":84,"column":79}},"value":{"raw":" and uploaded to ","cooked":" and uploaded to "},"tail":false},{"type":"TemplateElement","start":3051,"end":3052,"loc":{"start":{"line":84,"column":91},"end":{"line":84,"column":92}},"value":{"raw":"/","cooked":"/"},"tail":false},{"type":"TemplateElement","start":3061,"end":3061,"loc":{"start":{"line":84,"column":101},"end":{"line":84,"column":101}},"value":{"raw":"","cooked":""},"tail":true}]}}},{"type":"ExpressionStatement","start":3076,"end":3093,"loc":{"start":{"line":85,"column":12},"end":{"line":85,"column":29}},"expression":{"type":"CallExpression","start":3076,"end":3092,"loc":{"start":{"line":85,"column":12},"end":{"line":85,"column":28}},"callee":{"type":"MemberExpression","start":3076,"end":3087,"loc":{"start":{"line":85,"column":12},"end":{"line":85,"column":23}},"object":{"type":"Identifier","start":3076,"end":3083,"loc":{"start":{"line":85,"column":12},"end":{"line":85,"column":19},"identifierName":"console"},"name":"console"},"property":{"type":"Identifier","start":3084,"end":3087,"loc":{"start":{"line":85,"column":20},"end":{"line":85,"column":23},"identifierName":"log"},"name":"log"},"computed":false},"arguments":[{"type":"Identifier","start":3088,"end":3091,"loc":{"start":{"line":85,"column":24},"end":{"line":85,"column":27},"identifierName":"msg"},"name":"msg"}]}}],"directives":[]}},{"type":"ExpressionStatement","start":3112,"end":3131,"loc":{"start":{"line":87,"column":8},"end":{"line":87,"column":27}},"expression":{"type":"CallExpression","start":3112,"end":3130,"loc":{"start":{"line":87,"column":8},"end":{"line":87,"column":26}},"callee":{"type":"Identifier","start":3112,"end":3120,"loc":{"start":{"line":87,"column":8},"end":{"line":87,"column":16},"identifierName":"callback"},"name":"callback"},"arguments":[{"type":"Identifier","start":3121,"end":3124,"loc":{"start":{"line":87,"column":17},"end":{"line":87,"column":20},"identifierName":"err"},"name":"err"},{"type":"Identifier","start":3126,"end":3129,"loc":{"start":{"line":87,"column":22},"end":{"line":87,"column":25},"identifierName":"msg"},"name":"msg"}]}}],"directives":[]}}],"leadingComments":null},"leadingComments":[{"type":"CommentLine","value":" Download the image from S3, transform, and upload under new key.","start":1221,"end":1288,"loc":{"start":{"line":39,"column":4},"end":{"line":39,"column":71}}}]}],"directives":[]}}}}],"directives":[]},"comments":[{"type":"CommentLine","value":" adapted from https://docs.aws.amazon.com/lambda/latest/dg/with-s3-example-deployment-pkg.html","start":0,"end":96,"loc":{"start":{"line":1,"column":0},"end":{"line":1,"column":96}}},{"type":"CommentLine","value":" dependencies","start":98,"end":113,"loc":{"start":{"line":3,"column":0},"end":{"line":3,"column":15}}},{"type":"CommentLine","value":" Enable ImageMagick integration.","start":235,"end":269,"loc":{"start":{"line":7,"column":38},"end":{"line":7,"column":72}}},{"type":"CommentLine","value":" get reference to S3 client ","start":299,"end":329,"loc":{"start":{"line":10,"column":0},"end":{"line":10,"column":30}}},{"type":"CommentLine","value":" constants","start":356,"end":368,"loc":{"start":{"line":13,"column":0},"end":{"line":13,"column":12}}},{"type":"CommentLine","value":" Read options from the event.","start":478,"end":509,"loc":{"start":{"line":19,"column":4},"end":{"line":19,"column":35}}},{"type":"CommentLine","value":" Object key may have spaces or unicode non-ASCII characters.","start":599,"end":661,"loc":{"start":{"line":21,"column":4},"end":{"line":21,"column":66}}},{"type":"CommentLine","value":" Infer the image type.","start":876,"end":900,"loc":{"start":{"line":27,"column":4},"end":{"line":27,"column":28}}},{"type":"CommentLine","value":" Download the image from S3, transform, and upload under new key.","start":1221,"end":1288,"loc":{"start":{"line":39,"column":4},"end":{"line":39,"column":71}}},{"type":"CommentLine","value":" Download the image from S3 into a buffer.","start":1357,"end":1401,"loc":{"start":{"line":42,"column":12},"end":{"line":42,"column":56}}},{"type":"CommentLine","value":" Infer the scaling factor to avoid stretching the image unnaturally.","start":1648,"end":1718,"loc":{"start":{"line":50,"column":16},"end":{"line":50,"column":86}}},{"type":"CommentLine","value":" Transform the image buffer in memory.","start":2004,"end":2044,"loc":{"start":{"line":58,"column":16},"end":{"line":58,"column":56}}},{"type":"CommentLine","value":" Stream the transformed image to a different S3 bucket.","start":2471,"end":2528,"loc":{"start":{"line":70,"column":12},"end":{"line":70,"column":69}}}]},"formatted":true,"resources":["s3sigmaS3Thumb","s3sigmaS3Thumb","s3sigmaS3Thumb","s3sigmaS3Thumb"],"triggers":["sigmaS3Thumbs3ObjectCreatedjpg","sigmaS3Thumbs3ObjectCreatedpng"]}},"rootNode":"5e54d49e-8477-4f74-b2fb-883f1c69b7b8","openFiles":["702971c8-fa81-4c9f-9935-f46156b62d1d"],"currentFileId":"702971c8-fa81-4c9f-9935-f46156b62d1d","resources":{"s3sigmaS3Thumb":{"name":"s3sigmaS3Thumb","type":"S3","config":{"mode":1,"bucket":{"region":"us-east-1","name":"sigma-s3-thumb"}},"usage":{"702971c8-fa81-4c9f-9935-f46156b62d1d":{"operations":{},"occurrence":2,"triggers":{"sigmaS3Thumbs3ObjectCreatedjpg":{"type":"s3:ObjectCreated:*","keyPrefix":"","keySuffix":".jpg"},"sigmaS3Thumbs3ObjectCreatedpng":{"type":"s3:ObjectCreated:*","keyPrefix":"","keySuffix":".png"}}}}}},"state":"CHANGED","triggers":{"sigmaS3Thumbs3ObjectCreatedjpg":{"702971c8-fa81-4c9f-9935-f46156b62d1d":{"resourceName":"s3sigmaS3Thumb","config":{"type":"s3:ObjectCreated:*","keyPrefix":"","keySuffix":".jpg"}}},"sigmaS3Thumbs3ObjectCreatedpng":{"702971c8-fa81-4c9f-9935-f46156b62d1d":{"resourceName":"s3sigmaS3Thumb","config":{"type":"s3:ObjectCreated:*","keyPrefix":"","keySuffix":".png"}}}},"packageJSON":{"dependencies":{"aws-sdk":{"name":"aws-sdk","version":"2.176.0","notRemovable":true},"slappforge-sdk":{"name":"@slappforge/slappforge-sdk","version":"0.0.3","notRemovable":true}}},"changeExistingProject":false,"startX":0,"startY":0,"draggedResourceName":"S3","draggedResourceType":"RT","draggedResourceId":null,"additionalFiles":[]},"PROJECT_META":{"projectName":"EZ","projectDescription":"thumbsup","projectVersion":"1.0.0","repoName":"EZ","repoUrl":"https://github.com/sigmaidetest/EZ"}}